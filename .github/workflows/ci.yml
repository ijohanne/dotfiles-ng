name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            extra-platforms = aarch64-linux

      - uses: cachix/cachix-action@v15
        with:
          name: nix-community
          skipPush: true

      - name: Check flake
        run: nix flake check --no-build

  build-darwin:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build macbook configuration
        run: nix build .#darwinConfigurations.macbook.system --dry-run

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - uses: cachix/cachix-action@v15
        with:
          name: nix-community
          skipPush: true

      - name: Build ij-desktop configuration
        run: nix build .#nixosConfigurations.ij-desktop.config.system.build.toplevel --dry-run

      - name: Build pakhet configuration
        run: nix build .#nixosConfigurations.pakhet.config.system.build.toplevel --dry-run

  build-rpi4:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            extra-platforms = aarch64-linux

      - uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - uses: cachix/cachix-action@v15
        with:
          name: nix-community
          skipPush: true

      - name: Build rpi4-stable image
        run: nix build .#nixosConfigurations.rpi4-stable.config.system.build.toplevel --dry-run

      - name: Build rpi4-unstable image
        run: nix build .#nixosConfigurations.rpi4-unstable.config.system.build.toplevel --dry-run
